---
title: "w205_lab2_dataexplo_3"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(dplyr)
library(ggplot2) 
library(lmtest)
library(sandwich)
library(stargazer)
library(sandwich)
library(janitor)
library(gridExtra)
library(car)
library(stringr)
```

```{r}
# Load in data 
d_artists <- read.csv("data/artists.csv", header = TRUE)
d_tracks <- read.csv("data/tracks.csv", header = TRUE)

# Get quick looks
# summary(d_artists)
# summary(d_tracks)

# Remove first two characters [' for artists 
d_tracks$artists <- str_sub(d_tracks$artists, 3)
#Remove last two characters '] for artists 
d_tracks$artists <- substring(d_tracks$artists,1, nchar(d_tracks$artists)-2)

# Remove first two characters [' for id_artist
d_tracks$id_artists <- str_sub(d_tracks$id_artists, 3)
#Remove last two characters '] for id_artist
d_tracks$id_artists <- substring(d_tracks$id_artists,1, nchar(d_tracks$id_artists)-2)

# Selecting relevant artist columns: id, followers, popularity 
d_artists$id_artists <- d_artists$id
d_artists$artist_popularity <- d_artists$popularity
d_artists <- d_artists %>% select(id_artists, followers, artist_popularity)

# Join d_artists and d_tracks on artist id
d_joined <- merge(x = d_tracks, y = d_artists, by = "id_artists", all.x = TRUE)

# Change id name to specify for songs 
d_joined$id_song <- d_joined$id

# Select only likely necessary variables (e.g. we don't really need song name)
d <- d_joined %>% select(id_song,
                         popularity,
                         duration_ms,
                         explicit,
                         release_date,
                         danceability, 
                         energy, 
                         key,
                         loudness, 
                         mode, 
                         speechiness, 
                         acousticness, 
                         instrumentalness,
                         liveness, 
                         valence, 
                         tempo, 
                         time_signature,
                         followers, 
                         artist_popularity)

# Check for NAs in filtered dataset
# summary(d)
# There are 117089 NAs for followers and artist_popularity 
# Suggest Filtering out these rows
d <- na.omit(d)
# summary(d) # Check 

#Create an exploration and testing subsets

exploration_size<-floor( nrow(d)*0.3)  # number of rows we are going to select, 30% of the dataset
set.seed(777)
random_selection = sample(seq_len(nrow(d)),size = exploration_size) #random selection of x rows


d_explore <- d[random_selection,] # the randomly selected rows for the exploration dataset
d_test <- d[-random_selection,]  #full dataset - previously selected rows = the testing dataset

d_explore <- d_explore %>% select(id_song, popularity, duration_ms, explicit, danceability, energy, speechiness, acousticness, instrumentalness, valence, followers)
```

# 1. Introduction - Annie 
- present the research question 
- explain concept we are trying to measure and how it will be operationalized: popularity
- 
# 2. Data and Research Design - Giorggio
- data that will be used
- type of model we will estimate (causal)
- our goals for the models we will develop 
- 
#3. Model Building Process - Giorggio
- identify the one or few variables that will allow us to derive conclusions relevant to our research question --> these need to be included in all model specifications
- explain how the variables we will be modeling are distributed 
- present the covariates; any problematic covariates? 
- any transformations we applied --> do any of them reveal any linearities in the data?
- relevant EDA information should be included 
danceability + explicit + speechiness + valence, data 

```{r, fig.width=6, fig.height = 12, fig.align='center', echo=FALSE}
p1 <- ggplot() +
  aes(x = d_explore$popularity) +  
  geom_histogram(bins = 20) + 
  labs(
    x = "Popularity",
    y = "Count",
    title = "Figure 1: Distribution of Popularity"
  )

p2 <- ggplot() +
  aes(x = log(d_explore$valence)) +  
  geom_histogram(bins = 20) + 
  labs(
    x = "Duration",
    y = "Count",
    title = "Figure 2: Distribution of Valence"
  )

p3 <- ggplot() +
  aes(x = d_explore$explicit) +  
  geom_histogram(bins = 20) + 
  labs(
    x = "Explicitness",
    y = "Count",
    title = "Figure 3: Distribution of Explicitness"
  )

p4 <- ggplot() +
  aes(x = d_explore$danceability) +  
  geom_histogram(bins = 20) + 
  labs(
    x = "Danceabilty",
    y = "Count",
    title = "Figure 4: Distribution of Danceability"
  )

p5 <- ggplot() +
  aes(x = d_explore$energy) +  
  geom_histogram(bins = 20) + 
  labs(
    x = "Emergy",
    y = "Count",
    title = "Figure 4: Distribution of Energy"
  )

p6 <- ggplot() +
  aes(x = d_explore$speechiness) +  
  geom_histogram(bins = 20) + 
  labs(
    x = "Speechiness",
    y = "Count",
    title = "Figure 4: Distribution of Speechiness"
  )

p7 <- ggplot() +
  aes(x = d_explore$acousticness) +  
  geom_histogram(bins = 20) + 
  labs(
    x = "Acousticness",
    y = "Count",
    title = "Figure 4: Distribution of Acousticeness"
  )

p8 <- ggplot() +
  aes(x = d_explore$followers) +  
  geom_histogram(bins = 20) + 
  labs(
    x = "Number of Artist Followers",
    y = "Count",
    title = "Figure 4: Distribution of Number of Artist Followers"
  )

p8b <- ggplot() +
  aes(x = log(d_explore$followers)) +  
  geom_histogram(bins = 20) + 
  labs(
    x = "Number of Artist Followers",
    y = "Count",
    title = "Figure 4: Distribution of Number of Artist Followers (ln)"
  )

grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, nrow = 5, ncol = 2)
```

```{r scatter plots, fig.width=5, fig.height = 8, fig.align='center', echo=FALSE}
p9 <- ggplot(
  d_explore, 
  aes(x = danceability, y = popularity)) + 
  geom_point(size = 1) + 
  labs(x = "Danceability", y = "Popularity", title = "Figure X: Danceability vs Popularity")

p10 <- ggplot(
  d_explore, 
  aes(x = duration_ms, y = popularity)) + 
  geom_point(size = 1) + 
  labs(x = "Duration", y = "Popularity", title = "Figure X: Duration vs Popularity")

p11 <- ggplot(
  d_explore, 
  aes(x = explicit, y = popularity)) + 
  geom_point(size = 1) + 
  labs(x = "Explicitness", y = "Popularity", title = "Figure X: Explicitness vs Popularity")

p12 <- ggplot(
  d_explore, 
  aes(x = energy, y = popularity)) + 
  geom_point(size = 1) + 
  labs(x = "Energy", y = "Popularity", title = "Figure X: Energy vs Popularity")

p13 <- ggplot(
  d_explore, 
  aes(x = speechiness, y = popularity)) + 
  geom_point(size = 1) + 
  labs(x = "Speechiness", y = "Popularity", title = "Figure X: Speechiness vs Popularity")

p14 <- ggplot(
  d_explore, 
  aes(x = acousticness, y= popularity)) + 
  geom_point(size = 1) + 
  labs(x = "Acousticness", y = "Popularity", title = "Figure X: Acousticeness vs Popularity")

p15 <- ggplot(
  d_explore, 
  aes(x = followers, y = popularity)) + 
  geom_point(size = 1) + 
  labs(x = "Number of Followers", y = "Popularity", title = "Figure X: Number of Followers vs Popularity")

p16 <- ggplot(
  d_explore, 
  aes(x = instrumentalness, y = popularity)) + 
  geom_point(size = 1) + 
  labs(x = "Number of Followers", y = "Popularity", title = "Figure X: Instrumentalness vs Popularity")

p17 <- ggplot(
  d_explore, 
  aes(x = valence, y = popularity)) + 
  geom_point(size = 1) + 
  labs(x = "Valence", y = "Popularity", title = "Figure X: Valence vs Popularity")


grid.arrange(p9, p10, p11, p12, p13, p14, p15, p16, p17, nrow = 5, ncol = 2)
```

```{r scatter plotsjkj, fig.width=5, fig.height = 8, fig.align='center', echo=FALSE}
p18 <- ggplot(
  d_explore, 
  aes(x = danceability, y = log(popularity))) + 
  geom_point(size = 1) + 
  labs(x = "Danceability", y = "Popularity", title = "Figure X: Danceability vs Popularity (ln)")

p19 <- ggplot(
  d_explore, 
  aes(x = duration_ms, y = log(popularity))) + 
  geom_point(size = 1) + 
  labs(x = "Duration", y = "Popularity", title = "Figure X: Duration vs Popularity (ln)")

p20 <- ggplot(
  d_explore, 
  aes(x = explicit, y = log(popularity))) + 
  geom_point(size = 1) + 
  labs(x = "Explicitness", y = "Popularity", title = "Figure X: Explicitness vs Popularity (ln)")

p21 <- ggplot(
  d_explore, 
  aes(x = energy, y =log(popularity))) + 
  geom_point(size = 1) + 
  labs(x = "Energy", y = "Popularity", title = "Figure X: Energy vs Popularity (ln)")

p22 <- ggplot(
  d_explore, 
  aes(x = speechiness, y = log(popularity))) + 
  geom_point(size = 1) + 
  labs(x = "Speechiness", y = "Popularity", title = "Figure X: Speechiness vs Popularity (ln)")

p23 <- ggplot(
  d_explore, 
  aes(x = acousticness, y=log(popularity))) + 
  geom_point(size = 1) + 
  labs(x = "Acousticness", y = "Popularity", title = "Figure X: Acousticeness vs Popularity (ln)")

p24 <- ggplot(
  d_explore, 
  aes(x = followers, y = log(popularity))) + 
  geom_point(size = 1) + 
  labs(x = "Number of Followers", y = "Popularity", title = "Figure X: Number of Followers vs Popularity (ln)")

p25 <- ggplot(
  d_explore, 
  aes(x = instrumentalness, y = log(popularity))) + 
  geom_point(size = 1) + 
  labs(x = "Number of Followers", y = "Popularity", title = "Figure X: Instrumentalness vs Popularity (ln)")

p26 <- ggplot(
  d_explore, 
  aes(x = valence, y = log(popularity))) + 
  geom_point(size = 1) + 
  labs(x = "Valence", y = "Popularity", title = "Figure X: Valence vs Popularity (ln)")


grid.arrange(p18, p19, p20, p21, p22, p23, p24, p25, p26, nrow = 5, ncol = 2)
```

```{r scatter plots2, fig.align='center', echo=FALSE}
# p18 <- ggplot(
#   d_explore, 
#   aes(x = danceability, y = log(popularity))) + 
#   geom_point(size = 1) + 
#   labs(x = "Danceability", y = "Popularity", title = "Figure X: Danceability vs Popularity")
# 
# p19 <- ggplot(
#   d_explore, 
#   aes(x = duration_ms, y = log(popularity))) + 
#   geom_point(size = 1) + 
#   labs(x = "Duration", y = "Popularity", title = "Figure X: Duration vs Popularity")
# 
# p20 <- ggplot(
#   d_explore, 
#   aes(x = explicit, y = log(popularity))) + 
#   geom_point(size = 1) + 
#   labs(x = "Explicitness", y = "Popularity", title = "Figure X: Explicitness vs Popularity")
# 
# p21 <- ggplot(
#   d_explore, 
#   aes(x = energy, y =log(popularity))) + 
#   geom_point(size = 1) + 
#   labs(x = "Energy", y = "Popularity", title = "Figure X: Energy vs Popularity")
# 
# p22 <- ggplot(
#   d_explore, 
#   aes(x = speechiness, y = log(popularity))) + 
#   geom_point(size = 1) + 
#   labs(x = "Speechiness", y = "Popularity", title = "Figure X: Speechiness vs Popularity")
# 
# p23 <- ggplot(
#   d_explore, 
#   aes(x = acousticness, y=log(popularity))) + 
#   geom_point(size = 1) + 
#   labs(x = "Acousticness", y = "Popularity", title = "Figure X: Acousticeness vs Popularity")
# 
p27 <- ggplot(
  d_explore, 
  aes(x = log(followers), y = log(popularity))) + 
  geom_point(size = 1) + 
  labs(x = "Number of Followers", y = "Popularity", title = "Figure X: Number of Followers (ln) vs Popularity (ln)")
p27
# p25 <- ggplot(
#   d_explore, 
#   aes(x = instrumentalness, y = log(popularity))) + 
#   geom_point(size = 1) + 
#   labs(x = "Number of Followers", y = "Popularity", title = "Figure X: Instrumentalness vs Popularity")
# 
# p26 <- ggplot(
#   d_explore, 
#   aes(x = valence, y = log(popularity))) + 
#   geom_point(size = 1) + 
#   labs(x = "Valence", y = "Popularity", title = "Figure X: Valence vs Popularity")
# 

#grid.arrange(p18, p19, p20, p21, p22, p23, p24, p25, p26, nrow = 5, ncol = 2)
```

```{r}


p <- ggcorrplot(d_explore[, 2:11])
p
```